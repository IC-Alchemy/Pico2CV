# Sequencer-to-CV Refactor Plan

## Objective

Refactor the sequencer so it exclusively outputs MIDI and four CVs:
- **CV1:** Pitch (updated per step)
- **CV2:** Velocity (updated per step)
- **CV3:** Filter cutoff (updated per step)
- **CV4:** Envelope (updated at 8kHz sample rate, i.e., audio-rate or fast control-rate)
- **MIDI:** Output remains as currently implemented
- **PWM Pin Selection:** Flexible
- **CV Output Range:** 0–5V
- **Hardware:** PWM outputs, smoothed by active lowpass filters

---

## 1. Sequencer Data Model & Step Processing

- **Step Data:**  
  The current `Step` struct already contains `note`, `velocity`, and `filter` fields. No structural changes needed for CV1–CV3.
- **Envelope Source:**  
  The envelope (CV4) is generated by the DSP code (`daisysp::Adsr env1`). This value must be routed to a PWM output at 8kHz.

---

## 2. PWM CV Output Architecture

### a. PWM Output Assignment
- Assign four available PWM-capable pins for CV1–CV4.
- Define macros or constants for these pins in `Pico2CV.ino`.

### b. CV Value Calculation & Scaling
- **CV1 (Pitch):**  
  - Map step note value to a voltage (e.g., 1V/octave or custom mapping).
- **CV2 (Velocity):**  
  - Map normalized velocity (0.0–1.0) to 0–5V.
- **CV3 (Filter):**  
  - Map normalized filter value (0.0–1.0) to 0–5V.
- **CV4 (Envelope):**  
  - Map envelope output (0.0–1.0) to 0–5V.

### c. PWM Update Logic
- **CV1–CV3:**  
  - Update PWM duty cycle at each sequencer step (in `onStepCallback`).
- **CV4:**  
  - Update PWM duty cycle at 8kHz (in the audio or control-rate loop).

### d. PWM Initialization
- Initialize all four PWM channels in `setup()`.

### e. Lowpass Filtering
- Ensure each PWM output is routed through an active lowpass filter (hardware design consideration, not code).

---

## 3. Integration Points

### a. Sequencer Step Advance
- In `onStepCallback` (or equivalent), after advancing the sequencer:
  - Set PWM duty cycles for CV1–CV3 based on the current step.

### b. Envelope Processing
- In the audio/control-rate loop, after processing the envelope:
  - Set PWM duty cycle for CV4.

### c. MIDI Output
- Leave MIDI output logic unchanged.

---

## 4. Data Flow Diagram (Mermaid)

```mermaid
flowchart TD
    subgraph Sequencer
        A[Step Data: note, velocity, filter]
        B[Advance Step]
    end
    subgraph DSP
        C[Envelope Generator (env1)]
        D[Audio/Control Loop @8kHz]
    end
    subgraph PWM
        E[CV1: Pitch PWM]
        F[CV2: Velocity PWM]
        G[CV3: Filter PWM]
        H[CV4: Envelope PWM]
    end
    subgraph Hardware
        I[Active Lowpass Filters]
        J[CV Outputs (0–5V)]
    end

    A --> B
    B -->|per step| E
    B -->|per step| F
    B -->|per step| G
    C -->|per sample| D
    D -->|per sample| H
    E --> I
    F --> I
    G --> I
    H --> I
    I --> J
```

---

## 5. Module/Function Changes

### a. Pico2CV.ino
- Add PWM initialization for four pins in `setup()`.
- Add helper functions to map step/envelope values to PWM duty cycles.
- In `onStepCallback`, update CV1–CV3 PWM outputs.
- In the audio/control loop, update CV4 PWM output.

### b. Sequencer
- No major changes needed; ensure step data is accessible for CV mapping.

### c. DSP/Envelope
- Expose envelope value for use in PWM update.

---

## 6. Timing & Synchronization

- **CV1–CV3:**  
  - Updated synchronously with sequencer steps (ensures tight timing with step changes).
- **CV4:**  
  - Updated at 8kHz for smooth envelope following.

---

## 7. Hardware Considerations

- Use PWM-capable pins with sufficient resolution (ideally ≥10 bits).
- Design active lowpass filters with cutoff frequency well below PWM frequency (e.g., <500Hz for 8kHz PWM).
- Ensure output op-amps can drive 0–5V cleanly.

---

## 8. Risk Assessment

- **PWM Resolution:**  
  - Low PWM resolution may cause audible stepping in CVs; use highest available.
- **Envelope Smoothing:**  
  - If PWM update rate or filter cutoff is too low, envelope CV may sound "steppy."
- **Voltage Scaling:**  
  - Ensure mapping and hardware scaling matches 0–5V requirement.
- **Timing:**  
  - Ensure no blocking code in PWM update paths to maintain real-time performance.

---

## Summary Table

| CV Output | Source                | Update Rate      | Mapping         | PWM Pin | Notes                |
|-----------|----------------------|------------------|-----------------|---------|----------------------|
| CV1       | Step note            | Per step         | Note→Voltage    | Flexible| 1V/oct or custom     |
| CV2       | Step velocity        | Per step         | 0–1→0–5V        | Flexible|                      |
| CV3       | Step filter          | Per step         | 0–1→0–5V        | Flexible|                      |
| CV4       | Envelope (env1)      | 8kHz (audio loop)| 0–1→0–5V        | Flexible| Smooth, fast update  |